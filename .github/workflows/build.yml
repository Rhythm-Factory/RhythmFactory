name: Build do projeto

on:
    push:
        branches: [main]
        tags:
          - "v*"

permissions:
  contents: write

jobs:
    build-linux:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Instalar dependências do sistema
            run: |
              sudo apt update
              sudo apt install -y \
                libgtk-3-dev \
                libwebkit2gtk-4.1-dev \
                libappindicator3-dev \
                librsvg2-dev \
                patchelf \
                pkg-config \
                libglib2.0-dev
            
          - name: Instalar Node
            uses: actions/setup-node@v4
            with:
                node-version: 18

          - name: Instalar dependências
            run: npm install

          - name: Build frontend
            run: npm run build

          - name: Build Tauri
            run: npm run tauri build

          - name: Upload Linux artifact
            uses: actions/upload-artifact@v4
            with:
              name: linux-build
              path: src-tauri/target/release/bundle/appimage/*.AppImage

    build-windows:
        runs-on: windows-latest
        steps:
          - uses: actions/checkout@v4

          - name: Instalar Node
            uses: actions/setup-node@v4
            with:
                node-version: 18

          - name: Instalar dependências
            run: npm install

          - name: Build frontend
            run: npm run build

          - name: Build Tauri
            run: npm run tauri build

          - name: Upload app do Windows
            uses: actions/upload-artifact@v4
            with:
              name: windows-build
              path: src-tauri/target/release/bundle/**/*.exe

    build-mac:
        runs-on: macos-latest
        steps:
          - uses: actions/checkout@v4

          - name: Instalar Node
            uses: actions/setup-node@v4
            with:
                node-version: 18

          - name: Instalar dependências
            run: npm install

          - name: Build frontend
            run: npm run build

          - name: Build Tauri
            run: npm run tauri build
            
          - name: Upload dmg do MacOS
            uses: actions/upload-artifact@v4
            with:
              name: macos-build
              path: src-tauri/target/release/bundle/dmg/*.dmg

    release:
        if: startsWith(github.ref, 'refs/tags/')
        needs: [build-mac, build-windows, build-linux]
        runs-on: ubuntu-latest

        steps:
          - name: Download artifacts
            uses: actions/download-artifact@v4

          - name: Criar Release
            uses: softprops/action-gh-release@v2
            with:
              files: |
                macos-build/**/*.dmg
                windows-build/**/*.exe
                linux-build/**/*.AppImage

